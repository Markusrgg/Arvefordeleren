@using System.Collections.Generic
@using Arvefordeleren_ClassLibrary.Models
@using Arvefordeleren_WebApp.Components.Non_Routeable
@page "/assets"
@inject AssetService AssetService

<h3>Asset Manager</h3>

<EditForm Model="@newAsset" OnValidSubmit="@HandleValidSubmit" FormName="assetForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div>
        <label>Name:</label>
        <InputText @bind-Value="@newAsset.Name" />
    </div>
    <div>
        <label>Value:</label>
        <InputNumber @bind-Value="@newAsset.Value" />
    </div>
    <div>
        <label>Separate Estate:</label>
        <InputText @bind-Value="@newAsset.SeparateEstate" />
    </div>
    <button type="submit">@((isEditing ? "Update Asset" : "Create Asset"))</button>
    @if (isEditing)
    {
        <button type="button" @onclick="CancelEdit">Cancel</button>
    }
</EditForm>

@if (assets != null && assets.Count > 0)
{
    <ul>
        @foreach (var asset in assets)
        {
            <li>
                <strong>@asset.Name</strong> - @asset.Value - @asset.SeparateEstate
                <button @onclick="() => EditAsset(asset)">Edit</button>
                <button @onclick="() => DeleteAsset(asset.Id)">Delete</button>
            </li>
        }
    </ul>
}
else
{
    <p>No assets found.</p>
}

@code {
    private List<Asset> assets = new List<Asset>();
    private Asset newAsset = new Asset();
    private bool isEditing = false;
    private Guid? editingAssetId;

    protected override async Task OnInitializedAsync()
    {
        await LoadAssets();
    }

    private async Task LoadAssets()
    {
        assets = await AssetService.GetAllAssets();
        StateHasChanged(); // Ensure component updates after loading assets
    }

    private async Task CreateAsset()
    {
        await AssetService.CreateAsset(newAsset);
        await LoadAssets(); // Refresh the asset list
        ResetForm(); // Reset the form after creating an asset
    }

    private void EditAsset(Asset asset)
    {
        newAsset = new Asset
            {
                Id = asset.Id,
                Name = asset.Name,
                Value = asset.Value,
                SeparateEstate = asset.SeparateEstate
            };
        isEditing = true;
        editingAssetId = asset.Id;
    }

    private async Task UpdateAsset()
    {
        if (editingAssetId.HasValue)
        {
            newAsset.Id = editingAssetId.Value;
            await AssetService.UpdateAsset(newAsset);
            await LoadAssets(); // Refresh the asset list
            ResetForm(); // Reset the form after updating
        }
    }

    private async Task DeleteAsset(Guid id)
    {
        await AssetService.DeleteAsset(id);
        await LoadAssets();
    }

    private void CancelEdit()
    {
        ResetForm(); // Reset the form when canceling edit
    }

    private async Task HandleValidSubmit()
    {
        if (isEditing)
        {
            await UpdateAsset();
        }
        else
        {
            await CreateAsset();
        }
    }

    private void ResetForm()
    {
        newAsset = new Asset(); // Clear the form
        isEditing = false; // Exit editing mode
        editingAssetId = null; // Clear the ID
    }
}